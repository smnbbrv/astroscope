---
import '../styles/index.css';
import { i18n } from '@astroscope/i18n';
import { I18nScript } from '@astroscope/i18n/components';
import { t } from '@astroscope/i18n/t';
import Layout from '../../../shared/Layout.astro';
import AddToCartButton from '../components/AddToCartButton';
import Cart from '../components/Cart';
import CircularA from '../components/CircularA';
import CircularB from '../components/CircularB';
import CookieBanner from '../components/CookieBanner';
import FallbackTest from '../components/FallbackTest';
import LazyLoadDemo from '../components/LazyLoadDemo';
import Newsletter from '../components/Newsletter';
import ProductCard from '../components/ProductCard';
import ProductCardNested from '../components/ProductCardNested';
import ProductList from '../components/ProductList';

const { keys, chunks, imports } = i18n.getManifest();
---

<Layout title="i18n Demo" package="@astroscope/i18n">
  <I18nScript slot="head" />

  <p class="text-lg mb-6">
    This demo shows the @astroscope/i18n integration with same t() API in Astro and React.
  </p>

  <div class="flex gap-2 mb-6">
    <span class="font-semibold">Switch locale:</span>
    <a href="/?locale=en" class="btn btn-sm btn-ghost">English</a>
    <a href="/?locale=de" class="btn btn-sm btn-ghost">Deutsch</a>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">Astro Component (SSR)</h2>
      <p class="text-sm text-base-content/70 mb-4">Server-rendered, no client JS needed.</p>
      <h3 class="text-xl font-semibold">{t('home.title', 'Welcome to our Store')}</h3>
      <p>{t('home.description', 'Find the best products here')}</p>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">
        React Island — <code class="badge badge-ghost">client:load-x</code>
      </h2>
      <p class="text-sm text-base-content/70 mb-4">
        Hydrates immediately on page load. Use for interactive components above the fold.
      </p>
      <Cart client:load-x itemCount={3} total="$49.99" />
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">
        React Island — <code class="badge badge-ghost">client:idle-x</code>
      </h2>
      <p class="text-sm text-base-content/70 mb-4">
        Hydrates when the browser is idle. Good for lower-priority interactivity.
      </p>
      <Newsletter client:idle-x />
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">
        React Island — <code class="badge badge-ghost">client:visible-x</code>
      </h2>
      <p class="text-sm text-base-content/70 mb-4">
        Hydrates when scrolled into view. Perfect for content below the fold.
      </p>
      <div class="grid grid-cols-3 gap-4 mt-4">
        <ProductCard client:visible-x name="Wireless Headphones" price="$79.99" image="#6366f1" />
        <ProductCard client:visible-x name="Smart Watch" price="$199.99" image="#ec4899" />
        <ProductCard client:visible-x name="USB-C Hub" price="$49.99" image="#14b8a6" />
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">Fallback Behavior</h2>
      <p class="text-sm text-base-content/70 mb-4">
        When translations are missing from CMS, the example value is used as fallback.
      </p>
      <FallbackTest client:load-x />
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">
        Lazy Loading with <code class="badge badge-ghost">importx</code>
      </h2>
      <p class="text-sm text-base-content/70 mb-4">
        Use <code>importx()</code> inside React components to dynamically import other components. Translations for the
        lazy chunk load in parallel with the JS bundle.
      </p>
      <LazyLoadDemo client:load-x />
    </div>
  </div>

  <CookieBanner client:idle-x />

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">
        Nested Components Test — <code class="badge badge-ghost">client:visible-x</code>
      </h2>
      <p class="text-sm text-base-content/70 mb-4">
        Tests translation preloading for nested components: ProductList → ProductCardNested → AddToCartButton.
        Open DevTools Network tab, filter by "i18n", and reload to see translation loading order.
      </p>
      <ProductList client:visible-x />
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">
        Circular Dependency Test — <code class="badge badge-ghost">client:visible-x</code>
      </h2>
      <p class="text-sm text-base-content/70 mb-4">
        Tests circular import handling: CircularA imports CircularB, and CircularB imports CircularA.
        The flattening algorithm should detect and handle this without infinite loops.
      </p>
      <CircularA client:visible-x />
    </div>
  </div>

  <!-- Hidden components to ensure Vite creates separate chunks (never hydrates) -->
  <div style="display: none;">
    <ProductCardNested client:visible name="Hidden" price="$0" image="#000" />
    <AddToCartButton client:visible productName="Hidden" />
    <CircularB client:visible />
  </div>

  <div class="collapse collapse-arrow bg-base-100 shadow-xl mb-6">
    <input type="checkbox" />
    <div class="collapse-title font-semibold">
      Chunk Manifest (Debug)
      <span class="badge badge-neutral ml-2">{Object.keys(chunks).length} chunks</span>
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70 mb-2">Shows which translation keys are mapped to which chunks.</p>
      <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto text-xs"><code>{JSON.stringify(chunks, null, 2)}</code></pre>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-100 shadow-xl mb-6">
    <input type="checkbox" />
    <div class="collapse-title font-semibold">
      Imports Manifest (Debug)
      <span class="badge badge-neutral ml-2">{Object.keys(imports).length} chunks with deps</span>
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70 mb-2">Shows flattened import graph for translation prefetching. Circular deps are handled.</p>
      <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto text-xs"><code>{JSON.stringify(imports, null, 2)}</code></pre>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-100 shadow-xl mb-6">
    <input type="checkbox" />
    <div class="collapse-title font-semibold">
      Extracted Keys (Debug)
      <span class="badge badge-neutral ml-2">{keys.length} keys</span>
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70 mb-2">
        Translation keys extracted from codebase with metadata. Use this to populate your CMS.
      </p>
      <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto text-xs"><code>{JSON.stringify(keys, null, 2)}</code></pre>
    </div>
  </div>
</Layout>
