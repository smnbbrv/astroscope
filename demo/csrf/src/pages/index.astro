---
import '../styles/index.css';
import Layout from '../../../shared/Layout.astro';

if (Astro.request.method === 'POST') {
  const contentType = Astro.request.headers.get('content-type') ?? '';

  if (contentType.includes('form')) {
    const formData = await Astro.request.formData();

    console.log('Form submitted:', Object.fromEntries(formData));
  } else {
    console.log('POST received (no form data)');
  }
}

const baseUrl = Astro.url.origin;
---

<Layout title="CSRF Demo" package="@astroscope/csrf">
  <p class="text-lg mb-6">This demo shows the @astroscope/csrf middleware with path exclusions.</p>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">Protected Form (HTML)</h2>
      <p class="text-sm text-base-content/70 mb-4">
        Standard HTML form - browser sends correct Origin header automatically.
      </p>
      <form method="POST" class="flex gap-2">
        <input type="text" name="message" placeholder="Enter a message" class="input input-bordered flex-1" />
        <button type="submit" class="btn btn-primary">Submit Form</button>
      </form>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">Test CSRF Protection with curl</h2>
      <p class="text-sm text-base-content/70 mb-4">
        Browsers protect the <code class="badge badge-ghost">Origin</code> header, so use curl to test CSRF scenarios:
      </p>

      <div class="space-y-4">
        <div>
          <h3 class="font-semibold">
            <span class="text-success">✓</span> Same Origin (should succeed)
          </h3>
          <pre class="bg-base-300 p-3 rounded-lg overflow-x-auto text-sm mt-1"><code>curl -X POST -H "Origin: {baseUrl}" {baseUrl}/</code></pre>
        </div>

        <div>
          <h3 class="font-semibold">
            <span class="text-error">✗</span> Cross Origin (should fail with 403)
          </h3>
          <pre class="bg-base-300 p-3 rounded-lg overflow-x-auto text-sm mt-1"><code>curl -X POST -H "Origin: https://evil.com" {baseUrl}/</code></pre>
        </div>

        <div>
          <h3 class="font-semibold">
            <span class="text-error">✗</span> No Origin (should fail with 403)
          </h3>
          <pre class="bg-base-300 p-3 rounded-lg overflow-x-auto text-sm mt-1"><code>curl -X POST {baseUrl}/</code></pre>
        </div>

        <div>
          <h3 class="font-semibold">
            <span class="text-success">✓</span> Excluded Path (should succeed without Origin)
          </h3>
          <pre class="bg-base-300 p-3 rounded-lg overflow-x-auto text-sm mt-1"><code>curl -X POST {baseUrl}/webhook</code></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class="card-title">Excluded Paths</h2>
      <p class="text-sm text-base-content/70 mb-4">
        These paths bypass CSRF protection (useful for webhooks, OAuth callbacks, etc.):
      </p>
      <ul class="list-disc list-inside space-y-1">
        <li>
          <code class="badge badge-ghost">/auth/*</code> - OIDC callbacks (excluded)
        </li>
        <li>
          <code class="badge badge-ghost">/webhook</code> - Payment webhooks (excluded)
        </li>
      </ul>
    </div>
  </div>
</Layout>
