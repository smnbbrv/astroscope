---
import '../styles/index.css';
import { Trace } from '@astroscope/opentelemetry/components';
import Layout from '../../../shared/Layout.astro';
import DataFetcher from '../components/DataFetcher.astro';
import SlowComponent from '../components/SlowComponent.astro';
---

<Layout title="OpenTelemetry Demo" package="@astroscope/opentelemetry">
  <p class="text-lg mb-6">
    This demo showcases <code class="badge badge-ghost">@astroscope/opentelemetry</code> tracing capabilities. Run a
    collector (like Jaeger) to see traces.
  </p>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">1. Component Tracing with <code class="badge badge-ghost">&lt;Trace&gt;</code></h2>

      <h3 class="font-semibold mt-4">Streaming Mode (default)</h3>
      <p class="text-sm text-base-content/70 mb-2">
        Creates instant marker spans (<code>&gt;&gt; name</code>) without blocking streaming. Components render in
        parallel:
      </p>
      <div class="bg-base-200 p-4 rounded-lg space-y-2">
        <Trace name="hero">
          <SlowComponent name="Hero" delay={150} />
        </Trace>
        <Trace name="sidebar">
          <SlowComponent name="Sidebar" delay={100} />
        </Trace>
        <Trace name="footer">
          <SlowComponent name="Footer" delay={50} />
        </Trace>
      </div>

      <h3 class="font-semibold mt-4">Timing Mode (<code class="badge badge-ghost">withTimings</code>)</h3>
      <p class="text-sm text-base-content/70 mb-2">
        Creates spans with accurate duration (<code>RENDER name</code>). Use for single components where you need
        timing:
      </p>
      <div class="bg-base-200 p-4 rounded-lg">
        <Trace name="data-section" withTimings>
          <SlowComponent name="Data Section" delay={200} />
        </Trace>
      </div>

      <h3 class="font-semibold mt-4">Nested Tracing</h3>
      <p class="text-sm text-base-content/70 mb-2">Traces nest properly showing parent-child relationships:</p>
      <div class="bg-base-200 p-4 rounded-lg">
        <Trace name="card-container" withTimings>
          <Trace name="card-header" withTimings>
            <SlowComponent name="Card Header" delay={50} />
          </Trace>
          <Trace name="card-body" withTimings>
            <SlowComponent name="Card Body" delay={100} />
          </Trace>
        </Trace>
      </div>

      <h3 class="font-semibold mt-4">With Custom Parameters</h3>
      <div class="bg-base-200 p-4 rounded-lg">
        <Trace name="user-profile" params={{ userId: '123', role: 'admin' }} withTimings>
          <SlowComponent name="User Profile" delay={75} />
        </Trace>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">2. Fetch Tracing</h2>
      <p class="text-sm text-base-content/70 mb-4">
        Outgoing <code class="badge badge-ghost">fetch()</code> calls are automatically traced as
        <code>FETCH GET</code> spans:
      </p>
      <div class="bg-base-200 p-4 rounded-lg">
        <Trace name="api-calls" withTimings>
          <DataFetcher endpoint="https://jsonplaceholder.typicode.com/posts/1" />
        </Trace>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">3. HTTP Request Tracing</h2>
      <p class="text-sm text-base-content/70 mb-4">Every request creates a span with method and path:</p>
      <ul class="space-y-2">
        <li>
          <a href="/api/data" class="link link-primary">GET /api/data</a>
          <span class="badge badge-info ml-2">traced</span> - API endpoint with fetch
        </li>
        <li>
          <a href="/health" class="link link-primary">GET /health</a>
          <span class="badge badge-ghost ml-2">excluded</span> - Excluded from tracing
        </li>
      </ul>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">4. Astro Actions</h2>
      <p class="text-sm text-base-content/70 mb-4">
        Actions appear as <code class="badge badge-ghost">ACTION actionName</code> spans:
      </p>
      <form id="greet-form" class="flex gap-2">
        <input type="text" name="name" placeholder="Your name" required class="input input-bordered flex-1" />
        <button type="submit" class="btn btn-primary">Greet</button>
      </form>
      <p id="greet-result" class="mt-2 text-sm"></p>
    </div>
  </div>

  <div class="alert alert-info">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>
      <strong>Tip:</strong> Open your browser's Network tab and watch the streaming behavior. Components with
      <code>withTimings</code> buffer their content, while default mode streams immediately.
    </span>
  </div>

  <script>
    /* eslint-disable prettier/prettier */
    import { actions } from 'astro:actions';

    const form = document.querySelector<HTMLFormElement>('#greet-form');
    const result = document.getElementById('greet-result');

    if (form && result) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const name = formData.get('name');

        const response = await actions.greet({ name: String(name) });

        if (response.error) {
          result.textContent = `Error: ${response.error.message}`;
        } else {
          result.textContent = response.data.message;
        }
      });
    }
    /* eslint-enable prettier/prettier */
  </script>
</Layout>
